<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skillzoy Academy - تعيين كلمة مرور جديدة</title>
  
  <style>
    :root {
      --primary: #4361ee;
      --error: #e63946;
      --success: #4cc9f0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    body {
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 400px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .alert {
      padding: 12px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .alert-error { background: #fee; color: var(--error); border: 1px solid #fcc; }
    .alert-success { background: #efe; color: #060; border: 1px solid #cfc; }
    
    .password-strength {
      font-size: 12px;
      margin-top: 5px;
    }
    
    .weak { color: var(--error); }
    .medium { color: orange; }
    .strong { color: green; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>تعيين كلمة مرور جديدة</h2>
      
      <div id="authAlert"></div>

      <form id="resetPasswordForm">
        <input type="hidden" id="resetToken">
        
        <div class="form-group">
          <label>كلمة المرور الجديدة</label>
          <input type="password" id="newPassword" required minlength="8">
          <div class="password-strength" id="passwordStrength"></div>
        </div>

        <div class="form-group">
          <label>تأكيد كلمة المرور</label>
          <input type="password" id="confirmPassword" required>
        </div>

        <button type="submit" id="submitBtn">
          <span id="submitText">تعيين كلمة المرور</span>
        </button>
      </form>
    </div>
  </div>

  <script>
    // 🔒 فئة إدارة إعادة تعيين كلمة المرور
    class PasswordResetHandler {
      constructor() {
        this.token = this.extractTokenFromURL();
        this.tokenExpiry = Date.now() + 15 * 60 * 1000; // 15 دقيقة
        this.setupEventListeners();
        this.validateToken();
      }

      extractTokenFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        return token ? this.sanitizeToken(token) : null;
      }

      sanitizeToken(token) {
        // تنظيف الـ token ومنع حقن الكود
        return token.replace(/[^a-zA-Z0-9\-_]/g, '');
      }

      setupEventListeners() {
        const form = document.getElementById('resetPasswordForm');
        const newPassword = document.getElementById('newPassword');
        
        if (form) {
          form.addEventListener('submit', (e) => this.handleSubmit(e));
        }
        
        if (newPassword) {
          newPassword.addEventListener('input', (e) => this.checkPasswordStrength(e.target.value));
        }

        // مراقبة تغييرات الـ DOM لمنع الهجمات
        this.setupDOMMonitoring();
      }

      setupDOMMonitoring() {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
              mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1 && node.tagName === 'SCRIPT') {
                  node.remove(); // منع إضافة scripts خبيثة
                }
              });
            }
          });
        });

        observer.observe(document.documentElement, {
          childList: true,
          subtree: true
        });
      }

      validateToken() {
        if (!this.token) {
          this.showAlert('⛔ رابط غير صالح أو منتهي الصلاحية', 'error');
          this.disableForm();
          return;
        }

        if (Date.now() > this.tokenExpiry) {
          this.showAlert('⛔ انتهت صلاحية الرابط. يرجى طلب رابط جديد', 'error');
          this.disableForm();
          return;
        }

        // يمكن إضافة تحقق من الـ token مع السيرفر هنا
        document.getElementById('resetToken').value = this.token;
      }

      async handleSubmit(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!this.validatePasswords(newPassword, confirmPassword)) {
          return;
        }

        await this.resetPassword(newPassword);
      }

      validatePasswords(newPassword, confirmPassword) {
        if (newPassword !== confirmPassword) {
          this.showAlert('⛔ كلمتا المرور غير متطابقتين', 'error');
          return false;
        }

        if (newPassword.length < 8) {
          this.showAlert('⛔ كلمة المرور يجب أن تكون 8 أحرف على الأقل', 'error');
          return false;
        }

        // تحقق من قوة كلمة المرور
        const strength = this.calculatePasswordStrength(newPassword);
        if (strength < 3) {
          this.showAlert('⛔ كلمة المرور ضعيفة. يجب أن تحتوي على أحرف كبيرة وصغيرة وأرقام', 'error');
          return false;
        }

        // منع كلمات المرور الشائعة
        const commonPasswords = ['12345678', 'password', 'qwertyui', '00000000'];
        if (commonPasswords.includes(newPassword.toLowerCase())) {
          this.showAlert('⛔ كلمة المرور مستخدمة بشكل شائع. اختر كلمة مرور أقوى', 'error');
          return false;
        }

        return true;
      }

      calculatePasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;
        
        return strength;
      }

      checkPasswordStrength(password) {
        const strength = this.calculatePasswordStrength(password);
        const strengthElement = document.getElementById('passwordStrength');
        
        let message = '';
        let className = '';
        
        if (password.length === 0) {
          message = '';
        } else if (strength < 3) {
          message = 'ضعيفة';
          className = 'weak';
        } else if (strength < 5) {
          message = 'متوسطة';
          className = 'medium';
        } else {
          message = 'قوية';
          className = 'strong';
        }
        
        strengthElement.textContent = message;
        strengthElement.className = `password-strength ${className}`;
      }

      async resetPassword(newPassword) {
        try {
          // محاكاة طلب Supabase
          await this.simulatePasswordReset(newPassword);
          
          this.showAlert('✅ تم تعيين كلمة المرور الجديدة بنجاح', 'success');
          
          // توجيه إلى صفحة Login بعد 3 ثواني
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 3000);
          
        } catch (error) {
          this.handleError(error);
        }
      }

      async simulatePasswordReset(newPassword) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // محاكاة فشل الـ token
            if (!this.token || this.token.length < 10) {
              reject(new Error('INVALID_TOKEN'));
            } else {
              resolve({ success: true });
            }
          }, 1000);
        });
      }

      handleError(error) {
        const errorMap = {
          'INVALID_TOKEN': '⛔ رابط غير صالح. يرجى طلب رابط جديد',
          'NETWORK_ERROR': '⛔ خطأ في الشبكة. يرجى المحاولة لاحقاً',
          'WEAK_PASSWORD': '⛔ كلمة المرور ضعيفة جداً'
        };

        const message = errorMap[error.message] || '⛔ حدث خطأ غير متوقع';
        this.showAlert(message, 'error');
      }

      disableForm() {
        const form = document.getElementById('resetPasswordForm');
        const inputs = form.querySelectorAll('input');
        const button = document.getElementById('submitBtn');
        
        inputs.forEach(input => input.disabled = true);
        button.disabled = true;
      }

      showAlert(message, type) {
        const alertDiv = document.getElementById('authAlert');
        alertDiv.textContent = message; // استخدام textContent لمنع XSS
        alertDiv.className = `alert alert-${type}`;
        
        setTimeout(() => {
          alertDiv.textContent = '';
          alertDiv.className = '';
        }, 5000);
      }
    }

    // 🚀 تهيئة النظام
    document.addEventListener('DOMContentLoaded', () => {
      new PasswordResetHandler();
      
      // حماية إضافية
      Object.seal(window);
      Object.freeze(Object.prototype);
    });

    // 🛡️ منع أي محاولات لتعديل الكود
    if (typeof Object.freeze === 'function') {
      Object.freeze(Function.prototype);
      Object.freeze(Array.prototype);
      Object.freeze(String.prototype);
    }
  </script>
</body>
</html>
