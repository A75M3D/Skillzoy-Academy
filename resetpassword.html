<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skillzoy Academy - ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</title>
  
  <style>
    :root {
      --primary: #4361ee;
      --error: #e63946;
      --success: #4cc9f0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    body {
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 400px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .alert {
      padding: 12px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .alert-error { background: #fee; color: var(--error); border: 1px solid #fcc; }
    .alert-success { background: #efe; color: #060; border: 1px solid #cfc; }
    
    .password-strength {
      font-size: 12px;
      margin-top: 5px;
    }
    
    .weak { color: var(--error); }
    .medium { color: orange; }
    .strong { color: green; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
      
      <div id="authAlert"></div>

      <form id="resetPasswordForm">
        <input type="hidden" id="resetToken">
        
        <div class="form-group">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
          <input type="password" id="newPassword" required minlength="8">
          <div class="password-strength" id="passwordStrength"></div>
        </div>

        <div class="form-group">
          <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input type="password" id="confirmPassword" required>
        </div>

        <button type="submit" id="submitBtn">
          <span id="submitText">ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
        </button>
      </form>
    </div>
  </div>

  <script>
    // ğŸ”’ ÙØ¦Ø© Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    class PasswordResetHandler {
      constructor() {
        this.token = this.extractTokenFromURL();
        this.tokenExpiry = Date.now() + 15 * 60 * 1000; // 15 Ø¯Ù‚ÙŠÙ‚Ø©
        this.setupEventListeners();
        this.validateToken();
      }

      extractTokenFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        return token ? this.sanitizeToken(token) : null;
      }

      sanitizeToken(token) {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ token ÙˆÙ…Ù†Ø¹ Ø­Ù‚Ù† Ø§Ù„ÙƒÙˆØ¯
        return token.replace(/[^a-zA-Z0-9\-_]/g, '');
      }

      setupEventListeners() {
        const form = document.getElementById('resetPasswordForm');
        const newPassword = document.getElementById('newPassword');
        
        if (form) {
          form.addEventListener('submit', (e) => this.handleSubmit(e));
        }
        
        if (newPassword) {
          newPassword.addEventListener('input', (e) => this.checkPasswordStrength(e.target.value));
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù€ DOM Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‡Ø¬Ù…Ø§Øª
        this.setupDOMMonitoring();
      }

      setupDOMMonitoring() {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
              mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1 && node.tagName === 'SCRIPT') {
                  node.remove(); // Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© scripts Ø®Ø¨ÙŠØ«Ø©
                }
              });
            }
          });
        });

        observer.observe(document.documentElement, {
          childList: true,
          subtree: true
        });
      }

      validateToken() {
        if (!this.token) {
          this.showAlert('â›” Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'error');
          this.disableForm();
          return;
        }

        if (Date.now() > this.tokenExpiry) {
          this.showAlert('â›” Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯', 'error');
          this.disableForm();
          return;
        }

        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ token Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‡Ù†Ø§
        document.getElementById('resetToken').value = this.token;
      }

      async handleSubmit(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!this.validatePasswords(newPassword, confirmPassword)) {
          return;
        }

        await this.resetPassword(newPassword);
      }

      validatePasswords(newPassword, confirmPassword) {
        if (newPassword !== confirmPassword) {
          this.showAlert('â›” ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†', 'error');
          return false;
        }

        if (newPassword.length < 8) {
          this.showAlert('â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
          return false;
        }

        // ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const strength = this.calculatePasswordStrength(newPassword);
        if (strength < 3) {
          this.showAlert('â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù ÙƒØ¨ÙŠØ±Ø© ÙˆØµØºÙŠØ±Ø© ÙˆØ£Ø±Ù‚Ø§Ù…', 'error');
          return false;
        }

        // Ù…Ù†Ø¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
        const commonPasswords = ['12345678', 'password', 'qwertyui', '00000000'];
        if (commonPasswords.includes(newPassword.toLowerCase())) {
          this.showAlert('â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø¨Ø´ÙƒÙ„ Ø´Ø§Ø¦Ø¹. Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ù‚ÙˆÙ‰', 'error');
          return false;
        }

        return true;
      }

      calculatePasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;
        
        return strength;
      }

      checkPasswordStrength(password) {
        const strength = this.calculatePasswordStrength(password);
        const strengthElement = document.getElementById('passwordStrength');
        
        let message = '';
        let className = '';
        
        if (password.length === 0) {
          message = '';
        } else if (strength < 3) {
          message = 'Ø¶Ø¹ÙŠÙØ©';
          className = 'weak';
        } else if (strength < 5) {
          message = 'Ù…ØªÙˆØ³Ø·Ø©';
          className = 'medium';
        } else {
          message = 'Ù‚ÙˆÙŠØ©';
          className = 'strong';
        }
        
        strengthElement.textContent = message;
        strengthElement.className = `password-strength ${className}`;
      }

      async resetPassword(newPassword) {
        try {
          // Ù…Ø­Ø§ÙƒØ§Ø© Ø·Ù„Ø¨ Supabase
          await this.simulatePasswordReset(newPassword);
          
          this.showAlert('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
          
          // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Login Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 3000);
          
        } catch (error) {
          this.handleError(error);
        }
      }

      async simulatePasswordReset(newPassword) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // Ù…Ø­Ø§ÙƒØ§Ø© ÙØ´Ù„ Ø§Ù„Ù€ token
            if (!this.token || this.token.length < 10) {
              reject(new Error('INVALID_TOKEN'));
            } else {
              resolve({ success: true });
            }
          }, 1000);
        });
      }

      handleError(error) {
        const errorMap = {
          'INVALID_TOKEN': 'â›” Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯',
          'NETWORK_ERROR': 'â›” Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹',
          'WEAK_PASSWORD': 'â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹'
        };

        const message = errorMap[error.message] || 'â›” Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';
        this.showAlert(message, 'error');
      }

      disableForm() {
        const form = document.getElementById('resetPasswordForm');
        const inputs = form.querySelectorAll('input');
        const button = document.getElementById('submitBtn');
        
        inputs.forEach(input => input.disabled = true);
        button.disabled = true;
      }

      showAlert(message, type) {
        const alertDiv = document.getElementById('authAlert');
        alertDiv.textContent = message; // Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent Ù„Ù…Ù†Ø¹ XSS
        alertDiv.className = `alert alert-${type}`;
        
        setTimeout(() => {
          alertDiv.textContent = '';
          alertDiv.className = '';
        }, 5000);
      }
    }

    // ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    document.addEventListener('DOMContentLoaded', () => {
      new PasswordResetHandler();
      
      // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
      Object.seal(window);
      Object.freeze(Object.prototype);
    });

    // ğŸ›¡ï¸ Ù…Ù†Ø¹ Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
    if (typeof Object.freeze === 'function') {
      Object.freeze(Function.prototype);
      Object.freeze(Array.prototype);
      Object.freeze(String.prototype);
    }
  </script>
</body>
</html>
