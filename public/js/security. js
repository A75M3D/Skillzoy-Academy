// public/js/security-full.js - Ø­Ù…Ø§ÙŠØ© Ø´Ø§Ù…Ù„Ø©
class SecurityManager {
    constructor() {
        this.csrfToken = null;
        this.requests = [];
        this.init();
    }

    init() {
        console.log('ðŸ”’ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ©...');
        this.setupCSRFProtection();
        this.setupXSSProtection();
        this.setupRateLimiting();
        this.setupSessionSecurity();
        this.setupClickjackingProtection();
        this.monitorSuspiciousActivity();
        
        console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¬Ø§Ù‡Ø²');
    }

    // ==================== CSRF PROTECTION ====================
    setupCSRFProtection() {
        this.generateCSRFToken();
        this.injectCSRFTokens();
        this.protectAjaxRequests();
        this.setupFormProtection();
    }

    generateCSRFToken() {
        this.csrfToken = 'csrf_' + Math.random().toString(36).substr(2, 16) + '_' + Date.now();
        sessionStorage.setItem('csrf_token', this.csrfToken);
        console.log('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ CSRF Token');
    }

    injectCSRFTokens() {
        // Ø­Ù‚Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            this.addTokenToForm(form);
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        this.observeNewForms();
    }

    addTokenToForm(form) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const oldTokens = form.querySelectorAll('input[name="csrf_token"]');
        oldTokens.forEach(token => token.remove());

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'csrf_token';
        tokenInput.value = this.csrfToken;
        form.appendChild(tokenInput);
    }

    observeNewForms() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.tagName === 'FORM') {
                        this.addTokenToForm(node);
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    protectAjaxRequests() {
        const originalFetch = window.fetch;
        window.fetch = (resource, options = {}) => {
            const method = options.method ? options.method.toUpperCase() : 'GET';
            
            if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                options.headers = {
                    ...options.headers,
                    'X-CSRF-Token': this.csrfToken
                };
            }
            
            return originalFetch(resource, options);
        };
    }

    setupFormProtection() {
        document.addEventListener('submit', (e) => {
            if (!this.validateCSRFToken(e.target)) {
                e.preventDefault();
                this.showSecurityAlert('Ø·Ù„Ø¨ ØºÙŠØ± Ø¢Ù…Ù†', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                return false;
            }
            
            console.log('âœ… Ø·Ù„Ø¨ Ø¢Ù…Ù† - CSRF Token ØµØ§Ù„Ø­');
        });
    }

    validateCSRFToken(form) {
        const formToken = form.querySelector('input[name="csrf_token"]')?.value;
        const sessionToken = sessionStorage.getItem('csrf_token');
        
        return formToken && sessionToken && formToken === sessionToken;
    }

    // ==================== XSS PROTECTION ====================
    setupXSSProtection() {
        this.sanitizeAllInputs();
        this.overrideDangerousFunctions();
    }

    sanitizeAllInputs() {
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', (e) => {
                e.target.value = this.sanitizeInput(e.target.value);
            });
            
            input.addEventListener('blur', (e) => {
                e.target.value = this.sanitizeInput(e.target.value);
            });
        });
    }

    sanitizeInput(value) {
        if (!value) return value;
        
        return value
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/'/g, '&#x27;')
            .replace(/"/g, '&quot;')
            .replace(/\//g, '&#x2F;')
            .replace(/javascript:/gi, '')
            .replace(/on\w+=/gi, '');
    }

    overrideDangerousFunctions() {
        // Ø­Ù…Ø§ÙŠØ© innerHTML
        const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;
        Object.defineProperty(Element.prototype, 'innerHTML', {
            set: function(value) {
                const sanitized = SecurityManager.sanitizeHTML(value);
                return originalInnerHTML.call(this, sanitized);
            }
        });
    }

    static sanitizeHTML(html) {
        const div = document.createElement('div');
        div.textContent = html;
        return div.innerHTML;
    }

    // ==================== RATE LIMITING ====================
    setupRateLimiting() {
        this.requests = JSON.parse(localStorage.getItem('rate_limits') || '[]');
        
        document.addEventListener('submit', (e) => {
            if (!this.checkRateLimit()) {
                e.preventDefault();
                this.showSecurityAlert('Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒØ¨ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                return;
            }
        });
    }

    checkRateLimit() {
        const now = Date.now();
        const oneMinuteAgo = now - 60000;
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        this.requests = this.requests.filter(time => time > oneMinuteAgo);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ (10 Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)
        if (this.requests.length >= 10) {
            return false;
        }
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        this.requests.push(now);
        localStorage.setItem('rate_limits', JSON.stringify(this.requests));
        
        return true;
    }

    // ==================== SESSION SECURITY ====================
    setupSessionSecurity() {
        this.setSessionTimeout();
        this.detectMultipleTabs();
    }

    setSessionTimeout() {
        let timeout;
        
        const resetTimer = () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                this.handleSessionExpiry();
            }, 30 * 60 * 1000); // 30 Ø¯Ù‚ÙŠÙ‚Ø©
        };

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø©
        ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
            document.addEventListener(event, resetTimer, { passive: true });
        });

        resetTimer();
    }

    handleSessionExpiry() {
        sessionStorage.removeItem('csrf_token');
        localStorage.removeItem('rate_limits');
        this.showSecurityAlert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©', 'Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³ØªÙƒ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©');
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    }

    detectMultipleTabs() {
        // Ù…Ù†Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        if (!sessionStorage.getItem('session_started')) {
            sessionStorage.setItem('session_started', Date.now().toString());
        }
    }

    // ==================== CLICKJACKING PROTECTION ====================
    setupClickjackingProtection() {
        if (window !== window.top) {
            window.top.location = window.location;
        }
    }

    // ==================== SUSPICIOUS ACTIVITY MONITORING ====================
    monitorSuspiciousActivity() {
        this.detectDevTools();
        this.preventCopyPaste();
        this.monitorKeyboardPatterns();
    }

    detectDevTools() {
        const element = new Image();
        Object.defineProperty(element, 'id', {
            get: () => {
                this.logSecurityEvent('DEVTOOLS_OPENED');
            }
        });
        console.debug(element);
    }

    preventCopyPaste() {
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('copy', (e) => e.preventDefault());
        document.addEventListener('cut', (e) => e.preventDefault());
    }

    monitorKeyboardPatterns() {
        let keystrokes = [];
        
        document.addEventListener('keydown', (e) => {
            const now = Date.now();
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¶ØºØ·Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            keystrokes = keystrokes.filter(k => now - k.time < 1000);
            
            keystrokes.push({
                key: e.key,
                time: now
            });
            
            // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù„ÙŠØ© (Ø£ÙƒØ«Ø± Ù…Ù† 20 Ø¶ØºØ·Ø© ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
            if (keystrokes.length > 20) {
                this.logSecurityEvent('AUTOMATED_TYPING_DETECTED');
            }
        });
    }

    // ==================== HELPER FUNCTIONS ====================
    showSecurityAlert(title, message) {
        // Ø¥Ù†Ø´Ø§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        
        alertDiv.innerHTML = `
            <strong>${title}</strong>
            <p style="margin: 5px 0 0 0; font-size: 14px;">${message}</p>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    logSecurityEvent(event, data = {}) {
        const log = {
            event,
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...data
        };
        
        console.warn('ðŸ”’ Ø­Ø¯Ø« Ø£Ù…Ù†ÙŠ:', log);
        
        // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠØŒ Ø£Ø±Ø³Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        this.sendSecurityLog(log);
    }

    sendSecurityLog(log) {
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ
        fetch('/api/security/log', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': this.csrfToken
            },
            body: JSON.stringify(log)
        }).catch(() => {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        });
    }

    // ==================== PUBLIC API ====================
    validateForm(form) {
        return this.validateCSRFToken(form);
    }

    refreshCSRFToken() {
        this.generateCSRFToken();
        this.injectCSRFTokens();
    }

    getSecurityStatus() {
        return {
            csrf: !!this.csrfToken,
            rateLimiting: this.requests.length,
            session: !!sessionStorage.getItem('session_started')
        };
    }
}
// Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ security-full.js
encryptSensitiveData(data) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Crypto API Ù„Ù„ØªØ´ÙÙŠØ±
    return crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: new Uint8Array(12) },
        encryptionKey,
        new TextEncoder().encode(data)
    );
}
// Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
document.addEventListener('DOMContentLoaded', () => {
    window.securityManager = new SecurityManager();
    
    // Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø­Ø§Ù‹ globally
    console.log('ðŸ”’ Security Manager loaded:', window.securityManager);
});

// Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
if (!window.securityManager) {
    window.securityManager = new SecurityManager();
}
